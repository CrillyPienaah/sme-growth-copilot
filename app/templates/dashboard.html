<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SME Growth Co-Pilot - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold">ðŸš€ SME Growth Co-Pilot</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/docs" class="hover:text-purple-200">API Docs</a>
                    <a href="/health" class="hover:text-purple-200">Health</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">Total Businesses</div>
                <div class="text-3xl font-bold text-purple-600" id="totalBusinesses">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">Total Plans</div>
                <div class="text-3xl font-bold text-indigo-600" id="totalPlans">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">Avg Success Rate</div>
                <div class="text-3xl font-bold text-green-600" id="avgSuccessRate">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">Avg Response Time</div>
                <div class="text-3xl font-bold text-blue-600" id="avgResponseTime">-</div>
            </div>
        </div>

        <!-- Agent Performance Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Agent Performance (Last 7 Days)</h2>
            <canvas id="agentPerformanceChart"></canvas>
        </div>

        <!-- Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Businesses -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Businesses</h2>
                <div id="businessesList" class="space-y-2">
                    <div class="text-gray-500 text-center py-8">Loading...</div>
                </div>
            </div>

            <!-- Agent Stats -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Agent Statistics</h2>
                <div id="agentStatsList" class="space-y-3">
                    <div class="text-gray-500 text-center py-8">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display data
        async function loadDashboard() {
            try {
                // Load agent performance
                const agentResponse = await fetch('/monitoring/agents');
                const agentData = await agentResponse.json();
                
                // Update stats
                updateStats(agentData);
                
                // Create chart
                createAgentChart(agentData.agents);
                
                // Load businesses
                await loadBusinesses();
                
                // Display agent stats
                displayAgentStats(agentData.agents);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateStats(data) {
            const agents = data.agents || [];
            
            // Calculate totals
            const totalExecutions = agents.reduce((sum, agent) => sum + agent.total_executions, 0);
            const avgSuccess = agents.length > 0 
                ? agents.reduce((sum, agent) => sum + agent.success_rate, 0) / agents.length 
                : 0;
            const avgTime = agents.length > 0
                ? agents.reduce((sum, agent) => sum + agent.avg_execution_time_ms, 0) / agents.length
                : 0;
            
            document.getElementById('totalPlans').textContent = Math.floor(totalExecutions / 6); // 6 agents per plan
            document.getElementById('avgSuccessRate').textContent = avgSuccess.toFixed(1) + '%';
            document.getElementById('avgResponseTime').textContent = avgTime.toFixed(0) + 'ms';
        }

        async function loadBusinesses() {
            try {
                // This is a placeholder - you'd need to add an endpoint to list businesses
                const businessesHtml = `
                    <div class="text-sm text-gray-500">
                        <p>âœ… Businesses are being tracked in the database</p>
                        <p class="mt-2">Use the API endpoints to manage businesses:</p>
                        <code class="text-xs bg-gray-100 p-1 rounded">/plans/{business_id}</code>
                    </div>
                `;
                document.getElementById('businessesList').innerHTML = businessesHtml;
                document.getElementById('totalBusinesses').textContent = '3+';
            } catch (error) {
                console.error('Error loading businesses:', error);
            }
        }

        function createAgentChart(agents) {
            const ctx = document.getElementById('agentPerformanceChart').getContext('2d');
            
            const labels = agents.map(a => a.agent_name);
            const executionData = agents.map(a => a.total_executions);
            const successData = agents.map(a => a.success_rate);
            const timeData = agents.map(a => a.avg_execution_time_ms);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Executions',
                        data: executionData,
                        backgroundColor: 'rgba(147, 51, 234, 0.5)',
                        borderColor: 'rgb(147, 51, 234)',
                        borderWidth: 1
                    }, {
                        label: 'Avg Time (ms)',
                        data: timeData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: { display: true, text: 'Executions' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: { display: true, text: 'Time (ms)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function displayAgentStats(agents) {
            const html = agents.map(agent => `
                <div class="border-l-4 border-purple-500 bg-gray-50 p-4 rounded">
                    <div class="font-semibold text-lg">${agent.agent_name}</div>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-sm">
                        <div>
                            <span class="text-gray-500">Executions:</span>
                            <span class="font-bold">${agent.total_executions}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Success:</span>
                            <span class="font-bold text-green-600">${agent.success_rate}%</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Avg Time:</span>
                            <span class="font-bold">${agent.avg_execution_time_ms}ms</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('agentStatsList').innerHTML = html;
        }

        // Load dashboard on page load
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>